<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FinançasPRO</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  :root {
    --bg: #0a0c0f; --surface: #111418; --surface2: #181c22;
    --border: #252a32; --accent: #00e5a0; --accent2: #ff4d6d;
    --accent3: #ffd166; --accent4: #a78bfa; --text: #e8ecf0; --muted: #5a6370; --radius: 12px;
  }
  body { font-family: 'DM Mono', monospace; background: var(--bg); color: var(--text); min-height: 100vh; }
  .loading-overlay { position: fixed; inset: 0; background: var(--bg); display: flex; align-items: center; justify-content: center; z-index: 999; flex-direction: column; gap: 16px; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  .loading-text { font-size: 13px; color: var(--muted); }
  #authCard { min-height: 100vh; display: none; align-items: center; justify-content: center; background: var(--bg); position: relative; overflow: hidden; }
  #authCard::before { content: ''; position: absolute; width: 600px; height: 600px; background: radial-gradient(circle, rgba(0,229,160,0.08) 0%, transparent 70%); top: -150px; left: -150px; pointer-events: none; }
  #authCard::after { content: ''; position: absolute; width: 400px; height: 400px; background: radial-gradient(circle, rgba(167,139,250,0.06) 0%, transparent 70%); bottom: -100px; right: -100px; pointer-events: none; }
  .auth-box { width: 400px; background: var(--surface); border: 1px solid var(--border); border-radius: 20px; padding: 48px 40px; position: relative; z-index: 1; animation: slideUp 0.6s ease; }
  .auth-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 28px; color: var(--accent); margin-bottom: 6px; letter-spacing: -1px; }
  .auth-sub { color: var(--muted); font-size: 12px; margin-bottom: 28px; }
  .auth-tabs { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 28px; }
  .auth-tab { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface2); color: var(--muted); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
  .auth-tab.active { background: rgba(0,229,160,0.12); border-color: var(--accent); color: var(--accent); }
  .auth-box label { display: block; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .auth-box input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 14px; padding: 12px 14px; margin-bottom: 16px; outline: none; transition: border-color 0.2s; }
  .auth-box input:focus { border-color: var(--accent); }
  .btn-auth { width: 100%; background: var(--accent); color: #000; border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 15px; padding: 14px; cursor: pointer; transition: opacity 0.2s, transform 0.1s; margin-top: 4px; }
  .btn-auth:hover { opacity: 0.85; } .btn-auth:active { transform: scale(0.98); }
  .auth-error { color: var(--accent2); font-size: 12px; margin-top: 12px; text-align: center; min-height: 18px; }
  #app { display: none; }
  .topbar { display: flex; align-items: center; justify-content: space-between; padding: 18px 32px; border-bottom: 1px solid var(--border); background: var(--surface); position: sticky; top: 0; z-index: 100; }
  .topbar-logo { font-family: 'Syne', sans-serif; font-weight: 800; font-size: 20px; color: var(--accent); letter-spacing: -1px; }
  .topbar-user { font-size: 11px; color: var(--muted); max-width: 220px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .btn-logout { background: var(--surface2); color: var(--muted); border: 1px solid var(--border); border-radius: 7px; font-family: 'DM Mono', monospace; font-size: 12px; padding: 7px 14px; cursor: pointer; transition: color 0.2s, border-color 0.2s; margin-left: 16px; }
  .btn-logout:hover { color: var(--accent2); border-color: var(--accent2); }
  .main { max-width: 1100px; margin: 0 auto; padding: 32px 24px; }
  .ai-bar { background: var(--surface); border: 1px solid var(--accent4); border-radius: var(--radius); padding: 20px 24px; margin-bottom: 24px; position: relative; overflow: hidden; }
  .ai-bar::before { content: ''; position: absolute; inset: 0; background: linear-gradient(135deg, rgba(167,139,250,0.04) 0%, transparent 60%); pointer-events: none; }
  .ai-bar-header { display: flex; align-items: center; gap: 10px; margin-bottom: 14px; }
  .ai-badge { background: linear-gradient(135deg, #a78bfa, #60a5fa); border-radius: 6px; padding: 4px 10px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 11px; color: #000; letter-spacing: 0.5px; }
  .ai-bar-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; color: var(--text); }
  .ai-bar-sub { font-size: 11px; color: var(--muted); margin-left: auto; }
  .ai-input-row { display: flex; gap: 10px; }
  .ai-input { flex: 1; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 11px 14px; outline: none; transition: border-color 0.2s; }
  .ai-input:focus { border-color: var(--accent4); }
  .ai-input::placeholder { color: var(--muted); }
  .btn-ai { background: linear-gradient(135deg, #a78bfa, #60a5fa); color: #000; border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 13px; padding: 11px 20px; cursor: pointer; transition: opacity 0.2s; white-space: nowrap; }
  .btn-ai:hover { opacity: 0.85; } .btn-ai:disabled { opacity: 0.5; cursor: not-allowed; }
  .ai-response { margin-top: 14px; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; padding: 14px 16px; font-size: 13px; color: var(--text); line-height: 1.6; display: none; animation: slideUp 0.3s ease; }
  .ai-response.visible { display: block; }
  .ai-thinking { display: flex; align-items: center; gap: 8px; color: var(--muted); font-size: 12px; }
  .ai-dots span { display: inline-block; width: 5px; height: 5px; background: var(--accent4); border-radius: 50%; animation: bounce 1s infinite; }
  .ai-dots span:nth-child(2) { animation-delay: 0.15s; } .ai-dots span:nth-child(3) { animation-delay: 0.3s; }
  .ai-examples { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 12px; }
  .ai-example { background: var(--surface2); border: 1px solid var(--border); border-radius: 20px; font-size: 11px; color: var(--muted); padding: 5px 12px; cursor: pointer; transition: all 0.15s; }
  .ai-example:hover { color: var(--accent4); border-color: var(--accent4); }
  .summary-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; margin-bottom: 28px; }
  .summary-card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 22px 24px; position: relative; overflow: hidden; transition: transform 0.2s; }
  .summary-card:hover { transform: translateY(-2px); }
  .summary-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px; }
  .summary-card.receitas::before { background: var(--accent); } .summary-card.despesas::before { background: var(--accent2); } .summary-card.saldo::before { background: var(--accent3); }
  .summary-label { font-size: 11px; text-transform: uppercase; letter-spacing: 1.5px; color: var(--muted); margin-bottom: 10px; }
  .summary-value { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 28px; letter-spacing: -1px; }
  .summary-card.receitas .summary-value { color: var(--accent); } .summary-card.despesas .summary-value { color: var(--accent2); } .summary-card.saldo .summary-value { color: var(--accent3); }
  .summary-icon { position: absolute; right: 20px; top: 20px; font-size: 28px; opacity: 0.12; }
  .content-grid { display: grid; grid-template-columns: 1fr 380px; gap: 20px; align-items: start; }
  .card { background: var(--surface); border: 1px solid var(--border); border-radius: var(--radius); padding: 24px; margin-bottom: 20px; }
  .card-title { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 16px; margin-bottom: 20px; color: var(--text); }
  .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
  .form-group { margin-bottom: 14px; }
  .form-group label { display: block; font-size: 11px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; }
  .form-group input { width: 100%; background: var(--surface2); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: 'DM Mono', monospace; font-size: 13px; padding: 10px 12px; outline: none; transition: border-color 0.2s; }
  .form-group input:focus { border-color: var(--accent); }
  .tipo-toggle { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 16px; }
  .tipo-btn { padding: 10px; border-radius: 8px; border: 1px solid var(--border); background: var(--surface2); color: var(--muted); font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; text-align: center; }
  .tipo-btn.active-receita { background: rgba(0,229,160,0.12); border-color: var(--accent); color: var(--accent); }
  .tipo-btn.active-despesa { background: rgba(255,77,109,0.12); border-color: var(--accent2); color: var(--accent2); }
  .btn-salvar { width: 100%; background: var(--accent); color: #000; border: none; border-radius: 8px; font-family: 'Syne', sans-serif; font-weight: 700; font-size: 14px; padding: 13px; cursor: pointer; transition: opacity 0.2s; margin-top: 4px; }
  .btn-salvar:hover { opacity: 0.85; }
  .lista-wrapper { max-height: 420px; overflow-y: auto; }
  .lista-wrapper::-webkit-scrollbar { width: 4px; } .lista-wrapper::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }
  .transacao-item { display: flex; align-items: center; gap: 12px; padding: 14px 0; border-bottom: 1px solid var(--border); animation: slideUp 0.3s ease; }
  .transacao-item:last-child { border-bottom: none; }
  .t-badge { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }
  .t-badge.receita { background: rgba(0,229,160,0.12); } .t-badge.despesa { background: rgba(255,77,109,0.12); }
  .t-info { flex: 1; min-width: 0; }
  .t-cat { font-size: 13px; font-weight: 500; color: var(--text); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
  .t-desc { font-size: 11px; color: var(--muted); }
  .t-date { font-size: 11px; color: var(--muted); text-align: right; }
  .t-valor { font-family: 'Syne', sans-serif; font-weight: 700; font-size: 15px; text-align: right; min-width: 90px; }
  .t-valor.receita { color: var(--accent); } .t-valor.despesa { color: var(--accent2); }
  .t-actions { display: flex; gap: 6px; }
  .t-btn { background: var(--surface2); border: 1px solid var(--border); border-radius: 6px; color: var(--muted); font-size: 12px; padding: 5px 9px; cursor: pointer; transition: all 0.15s; }
  .t-btn:hover { color: var(--text); border-color: var(--text); } .t-btn.del:hover { color: var(--accent2); border-color: var(--accent2); }
  .empty-state { text-align: center; padding: 40px 20px; color: var(--muted); font-size: 13px; }
  .empty-state .emoji { font-size: 36px; margin-bottom: 12px; }
  .chart-container { position: relative; height: 240px; }
  .filter-row { display: flex; gap: 8px; margin-bottom: 16px; }
  .filter-chip { background: var(--surface2); border: 1px solid var(--border); color: var(--muted); border-radius: 20px; font-family: 'DM Mono', monospace; font-size: 11px; padding: 5px 12px; cursor: pointer; transition: all 0.15s; }
  .filter-chip.active { background: rgba(0,229,160,0.12); border-color: var(--accent); color: var(--accent); }
  .toast { position: fixed; bottom: 28px; right: 28px; background: var(--surface2); border: 1px solid var(--accent); border-radius: 10px; padding: 14px 20px; font-size: 13px; color: var(--accent); z-index: 9999; animation: slideUp 0.3s ease; box-shadow: 0 8px 32px rgba(0,229,160,0.15); }
  .toast.erro { border-color: var(--accent2); color: var(--accent2); box-shadow: 0 8px 32px rgba(255,77,109,0.15); }
  .toast.ia { border-color: var(--accent4); color: var(--accent4); box-shadow: 0 8px 32px rgba(167,139,250,0.15); }
  @keyframes spin { to { transform: rotate(360deg); } }
  @keyframes bounce { 0%, 80%, 100% { transform: scale(0.6); opacity: 0.4; } 40% { transform: scale(1); opacity: 1; } }
  @keyframes slideUp { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  @media (max-width: 768px) {
    .summary-grid { grid-template-columns: 1fr; } .content-grid { grid-template-columns: 1fr; }
    .form-row { grid-template-columns: 1fr; } .topbar { padding: 14px 16px; } .main { padding: 20px 14px; }
    .auth-box { width: 92%; padding: 36px 24px; } .summary-value { font-size: 22px; } .ai-bar-sub { display: none; }
  }
</style>
</head>
<body>
<div class="loading-overlay" id="loading">
  <div class="spinner"></div>
  <div class="loading-text">Carregando...</div>
</div>
<div id="authCard">
  <div class="auth-box">
    <div class="auth-logo">FinançasPRO</div>
    <div class="auth-sub">Login real com Firebase + Gemini AI</div>
    <div class="auth-tabs">
      <button class="auth-tab active" id="tabLogin" onclick="trocarAba('login')">Entrar</button>
      <button class="auth-tab" id="tabCadastro" onclick="trocarAba('cadastro')">Criar conta</button>
    </div>
    <div id="formLogin">
      <label>Email</label>
      <input type="email" id="loginEmail" placeholder="seu@email.com">
      <label>Senha</label>
      <input type="password" id="loginSenha" placeholder="••••••••">
      <button class="btn-auth" onclick="fazerLogin()">Entrar</button>
    </div>
    <div id="formCadastro" style="display:none;">
      <label>Email</label>
      <input type="email" id="cadEmail" placeholder="seu@email.com">
      <label>Senha (min. 6 caracteres)</label>
      <input type="password" id="cadSenha" placeholder="••••••••">
      <label>Confirmar senha</label>
      <input type="password" id="cadSenha2" placeholder="••••••••">
      <button class="btn-auth" onclick="fazerCadastro()">Criar conta</button>
    </div>
    <div class="auth-error" id="authErro"></div>
  </div>
</div>
<div id="app">
  <div class="topbar">
    <div class="topbar-logo">FinancasPRO</div>
    <div style="display:flex;align-items:center;gap:8px;">
      <div class="topbar-user" id="emailUsuario"></div>
      <button class="btn-logout" onclick="fazerLogout()">Sair</button>
    </div>
  </div>
  <div class="main">
    <div class="ai-bar">
      <div class="ai-bar-header">
        <div class="ai-badge">GEMINI AI</div>
        <div class="ai-bar-title">Assistente Financeiro</div>
        <div class="ai-bar-sub">Fale em portugues natural</div>
      </div>
      <div class="ai-input-row">
        <input class="ai-input" id="aiInput" placeholder="Ex: Gastei 45 reais no iFood hoje..." onkeydown="if(event.key==='Enter') enviarParaIA()">
        <button class="btn-ai" id="btnAI" onclick="enviarParaIA()">Enviar</button>
      </div>
      <div class="ai-examples">
        <span class="ai-example" onclick="usarExemplo(this)">Gastei 45 no iFood</span>
        <span class="ai-example" onclick="usarExemplo(this)">Recebi salario de 3000</span>
        <span class="ai-example" onclick="usarExemplo(this)">Paguei 120 de luz</span>
        <span class="ai-example" onclick="usarExemplo(this)">Quanto gastei esse mes?</span>
        <span class="ai-example" onclick="usarExemplo(this)">Qual meu saldo atual?</span>
        <span class="ai-example" onclick="usarExemplo(this)">Onde gasto mais?</span>
      </div>
      <div class="ai-response" id="aiResponse"></div>
    </div>
    <div class="summary-grid">
      <div class="summary-card receitas">
        <div class="summary-icon">up</div>
        <div class="summary-label">Receitas</div>
        <div class="summary-value">R$ <span id="totalReceita">0,00</span></div>
      </div>
      <div class="summary-card despesas">
        <div class="summary-icon">down</div>
        <div class="summary-label">Despesas</div>
        <div class="summary-value">R$ <span id="totalDespesa">0,00</span></div>
      </div>
      <div class="summary-card saldo">
        <div class="summary-icon">bal</div>
        <div class="summary-label">Saldo</div>
        <div class="summary-value">R$ <span id="saldo">0,00</span></div>
      </div>
    </div>
    <div class="content-grid">
      <div>
        <div class="card">
          <div class="card-title">Transacoes</div>
          <div class="filter-row">
            <button class="filter-chip active" onclick="setFiltro('todos',this)">Todos</button>
            <button class="filter-chip" onclick="setFiltro('receita',this)">Receitas</button>
            <button class="filter-chip" onclick="setFiltro('despesa',this)">Despesas</button>
          </div>
          <div class="lista-wrapper"><div id="lista"></div></div>
        </div>
        <div class="card">
          <div class="card-title">Gastos por Categoria</div>
          <div class="chart-container"><canvas id="grafico"></canvas></div>
        </div>
      </div>
      <div>
        <div class="card" style="position:sticky;top:80px;">
          <div class="card-title" id="formTitle">Nova Transacao</div>
          <div class="tipo-toggle">
            <button class="tipo-btn active-receita" id="btnReceita" onclick="setTipo('receita')">Receita</button>
            <button class="tipo-btn" id="btnDespesa" onclick="setTipo('despesa')">Despesa</button>
          </div>
          <div class="form-group">
            <label>Categoria</label>
            <input type="text" id="categoria" placeholder="Ex: Salario, iFood, Mercado">
          </div>
          <div class="form-group">
            <label>Descricao (opcional)</label>
            <input type="text" id="descricao" placeholder="Detalhes...">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Valor (R$)</label>
              <input type="number" id="valor" placeholder="0,00" step="0.01" min="0">
            </div>
            <div class="form-group">
              <label>Data</label>
              <input type="date" id="data">
            </div>
          </div>
          <button class="btn-salvar" id="btnSalvar" onclick="salvar()">Salvar Transacao</button>
        </div>
      </div>
    </div>
  </div>
</div>
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAhdcSuDS6_r_SjTHDOJBwA5hUBCvU--Sg",
    authDomain: "financaspro1100.firebaseapp.com",
    projectId: "financaspro1100",
    storageBucket: "financaspro1100.firebasestorage.app",
    messagingSenderId: "411300706683",
    appId: "1:411300706683:web:f1913633000c7f538425de"
  };
  const GEMINI_KEY = "AIzaSyBbjb3xGFZ-KtThUpqU43G6n_dS3wpRYSY";
  const GEMINI_URL = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=" + GEMINI_KEY;

  const fireApp = initializeApp(firebaseConfig);
  const auth = getAuth(fireApp);
  const db = getFirestore(fireApp);

  let transacoes = [], tipoAtual = 'receita', filtroAtual = 'todos', editandoId = null, grafico = null, uidAtual = null;

  window.trocarAba = trocarAba; window.fazerLogin = fazerLogin; window.fazerCadastro = fazerCadastro;
  window.fazerLogout = fazerLogout; window.setTipo = setTipo; window.setFiltro = setFiltro;
  window.salvar = salvar; window.excluir = excluir; window.editar = editar;
  window.enviarParaIA = enviarParaIA; window.usarExemplo = usarExemplo;

  onAuthStateChanged(auth, async (user) => {
    document.getElementById('loading').style.display = 'none';
    if (user) {
      uidAtual = user.uid;
      document.getElementById('emailUsuario').textContent = user.email;
      document.getElementById('authCard').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('data').valueAsDate = new Date();
      await carregarTransacoes();
    } else {
      uidAtual = null;
      document.getElementById('app').style.display = 'none';
      document.getElementById('authCard').style.display = 'flex';
    }
  });

  function trocarAba(aba) {
    document.getElementById('formLogin').style.display = aba === 'login' ? 'block' : 'none';
    document.getElementById('formCadastro').style.display = aba === 'cadastro' ? 'block' : 'none';
    document.getElementById('tabLogin').className = 'auth-tab' + (aba === 'login' ? ' active' : '');
    document.getElementById('tabCadastro').className = 'auth-tab' + (aba === 'cadastro' ? ' active' : '');
    document.getElementById('authErro').textContent = '';
  }

  async function fazerLogin() {
    const email = document.getElementById('loginEmail').value.trim();
    const senha = document.getElementById('loginSenha').value;
    document.getElementById('authErro').textContent = '';
    if (!email || !senha) { document.getElementById('authErro').textContent = 'Preencha email e senha.'; return; }
    try { await signInWithEmailAndPassword(auth, email, senha); }
    catch (e) { document.getElementById('authErro').textContent = traduzirErro(e.code); }
  }

  async function fazerCadastro() {
    const email = document.getElementById('cadEmail').value.trim();
    const senha = document.getElementById('cadSenha').value;
    const senha2 = document.getElementById('cadSenha2').value;
    document.getElementById('authErro').textContent = '';
    if (!email || !senha) { document.getElementById('authErro').textContent = 'Preencha todos os campos.'; return; }
    if (senha !== senha2) { document.getElementById('authErro').textContent = 'As senhas nao coincidem.'; return; }
    if (senha.length < 6) { document.getElementById('authErro').textContent = 'Senha deve ter pelo menos 6 caracteres.'; return; }
    try { await createUserWithEmailAndPassword(auth, email, senha); showToast('Conta criada!'); }
    catch (e) { document.getElementById('authErro').textContent = traduzirErro(e.code); }
  }

  async function fazerLogout() { await signOut(auth); transacoes = []; }

  async function carregarTransacoes() {
    try {
      const q = query(collection(db, 'transacoes'), where('uid', '==', uidAtual));
      const snap = await getDocs(q);
      transacoes = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      transacoes.sort((a, b) => (b.criadoEm || 0) - (a.criadoEm || 0));
      atualizar();
    } catch(e) { showToast('Erro ao carregar dados.', 'erro'); }
  }

  async function salvar(dadosIA = null) {
    const categoria = dadosIA ? dadosIA.categoria : document.getElementById('categoria').value.trim();
    const descricao = dadosIA ? dadosIA.descricao : document.getElementById('descricao').value.trim();
    const valor = dadosIA ? parseFloat(dadosIA.valor) : parseFloat(document.getElementById('valor').value);
    const data = dadosIA ? dadosIA.data : document.getElementById('data').value;
    const tipo = dadosIA ? dadosIA.tipo : tipoAtual;
    if (!valor || valor <= 0) { if (!dadosIA) showToast('Insira um valor valido', 'erro'); return false; }
    if (!categoria) { if (!dadosIA) showToast('Informe uma categoria', 'erro'); return false; }
    const item = { uid: uidAtual, tipo, categoria, descricao: descricao || '', valor, data, criadoEm: Date.now() };
    try {
      if (editandoId && !dadosIA) {
        await deleteDoc(doc(db, 'transacoes', editandoId));
        transacoes = transacoes.filter(t => t.id !== editandoId);
        editandoId = null;
        document.getElementById('formTitle').textContent = 'Nova Transacao';
        document.getElementById('btnSalvar').textContent = 'Salvar Transacao';
      }
      const ref = await addDoc(collection(db, 'transacoes'), item);
      transacoes.unshift({ id: ref.id, ...item });
      if (!dadosIA) limparForm();
      atualizar();
      return true;
    } catch(e) { showToast('Erro ao salvar.', 'erro'); return false; }
  }

  async function excluir(id) {
    if (!confirm('Excluir esta transacao?')) return;
    try {
      await deleteDoc(doc(db, 'transacoes', id));
      transacoes = transacoes.filter(t => t.id !== id);
      atualizar(); showToast('Transacao excluida');
    } catch(e) { showToast('Erro ao excluir.', 'erro'); }
  }

  function editar(id) {
    const t = transacoes.find(t => t.id === id);
    if (!t) return;
    editandoId = id; setTipo(t.tipo);
    document.getElementById('categoria').value = t.categoria;
    document.getElementById('descricao').value = t.descricao || '';
    document.getElementById('valor').value = t.valor;
    document.getElementById('data').value = t.data;
    document.getElementById('formTitle').textContent = 'Editar Transacao';
    document.getElementById('btnSalvar').textContent = 'Atualizar';
    window.scrollTo({ top: 0, behavior: 'smooth' });
  }

  function usarExemplo(el) {
    document.getElementById('aiInput').value = el.textContent;
    document.getElementById('aiInput').focus();
  }

  async function enviarParaIA() {
    const input = document.getElementById('aiInput').value.trim();
    if (!input) return;
    const btn = document.getElementById('btnAI');
    const respDiv = document.getElementById('aiResponse');
    btn.disabled = true; btn.textContent = '...';
    respDiv.className = 'ai-response visible';
    respDiv.innerHTML = '<div class="ai-thinking">Gemini pensando <div class="ai-dots"><span></span><span></span><span></span></div></div>';
    const hoje = new Date().toISOString().split('T')[0];
    const resumo = transacoes.slice(0, 20).map(t => t.tipo + '|' + t.categoria + '|R$' + t.valor + '|' + t.data).join('\n');
    const totalR = transacoes.filter(t=>t.tipo==='receita').reduce((s,t)=>s+t.valor,0);
    const totalD = transacoes.filter(t=>t.tipo==='despesa').reduce((s,t)=>s+t.valor,0);
    const prompt = `Voce e um assistente financeiro pessoal. Responda SEMPRE em portugues brasileiro.
DADOS: Data hoje: ${hoje} | Receitas: R$${totalR.toFixed(2)} | Despesas: R$${totalD.toFixed(2)} | Saldo: R$${(totalR-totalD).toFixed(2)}
ULTIMAS TRANSACOES:\n${resumo || 'Nenhuma ainda.'}
REGRAS:
1. Se o usuario quiser ADICIONAR transacao (gastei, paguei, recebi, comprei etc), responda SOMENTE com JSON valido:
{"acao":"adicionar","tipo":"despesa","categoria":"nome","descricao":"desc","valor":0.00,"data":"${hoje}","resposta":"confirmacao curta"}
2. Se for PERGUNTA sobre financas, responda em texto simples e util.
3. Se nao entender, peca esclarecimento.
MENSAGEM: "${input}"`;
    try {
      const res = await fetch(GEMINI_URL, {
        method: 'POST', headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
      });
      const data = await res.json();
      const texto = data.candidates?.[0]?.content?.parts?.[0]?.text || '';
      const jsonMatch = texto.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        try {
          const obj = JSON.parse(jsonMatch[0]);
          if (obj.acao === 'adicionar' && obj.valor && obj.categoria) {
            const ok = await salvar({ tipo: obj.tipo || 'despesa', categoria: obj.categoria, descricao: obj.descricao || input, valor: obj.valor, data: obj.data || hoje });
            if (ok) { respDiv.innerHTML = obj.resposta || 'Transacao adicionada!'; showToast('Gemini adicionou a transacao!', 'ia'); }
            else { respDiv.innerHTML = 'Nao consegui adicionar. Tente novamente.'; }
          } else { respDiv.innerHTML = texto.replace(/\n/g, '<br>'); }
        } catch { respDiv.innerHTML = texto.replace(/\n/g, '<br>'); }
      } else { respDiv.innerHTML = texto.replace(/\n/g, '<br>'); }
      document.getElementById('aiInput').value = '';
    } catch(e) { respDiv.innerHTML = 'Erro ao conectar com o Gemini. Verifique sua conexao.'; }
    btn.disabled = false; btn.textContent = 'Enviar';
  }

  function setTipo(tipo) {
    tipoAtual = tipo;
    document.getElementById('btnReceita').className = 'tipo-btn' + (tipo === 'receita' ? ' active-receita' : '');
    document.getElementById('btnDespesa').className = 'tipo-btn' + (tipo === 'despesa' ? ' active-despesa' : '');
  }

  function setFiltro(filtro, el) {
    filtroAtual = filtro;
    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
    el.classList.add('active'); renderLista();
  }

  function limparForm() {
    document.getElementById('categoria').value = ''; document.getElementById('descricao').value = '';
    document.getElementById('valor').value = ''; document.getElementById('data').valueAsDate = new Date();
  }

  function atualizar() {
    let receita = 0, despesa = 0; const categorias = {};
    transacoes.forEach(t => {
      if (t.tipo === 'receita') receita += t.valor;
      if (t.tipo === 'despesa') { despesa += t.valor; categorias[t.categoria] = (categorias[t.categoria] || 0) + t.valor; }
    });
    const fmt = n => n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    document.getElementById('totalReceita').textContent = fmt(receita);
    document.getElementById('totalDespesa').textContent = fmt(despesa);
    const saldo = receita - despesa;
    const saldoEl = document.getElementById('saldo');
    saldoEl.textContent = fmt(Math.abs(saldo));
    saldoEl.style.color = saldo < 0 ? 'var(--accent2)' : '';
    renderLista(); renderGrafico(categorias);
  }

  function renderLista() {
    const lista = document.getElementById('lista');
    const filtered = filtroAtual === 'todos' ? transacoes : transacoes.filter(t => t.tipo === filtroAtual);
    if (!filtered.length) { lista.innerHTML = '<div class="empty-state"><div class="emoji">chart</div>Nenhuma transacao ainda. Use o formulario ou o Gemini!</div>'; return; }
    const fmt = n => n.toLocaleString('pt-BR', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
    const fmtDate = d => d ? new Date(d + 'T00:00:00').toLocaleDateString('pt-BR') : '';
    lista.innerHTML = filtered.map(t => '<div class="transacao-item"><div class="t-badge ' + t.tipo + '">' + (t.tipo==='receita'?'R':'D') + '</div><div class="t-info"><div class="t-cat">' + t.categoria + '</div><div class="t-desc">' + (t.descricao||'') + '</div></div><div><div class="t-valor ' + t.tipo + '">R$ ' + fmt(t.valor) + '</div><div class="t-date">' + fmtDate(t.data) + '</div></div><div class="t-actions"><button class="t-btn" onclick="editar(\'' + t.id + '\')">Editar</button><button class="t-btn del" onclick="excluir(\'' + t.id + '\')">Excluir</button></div></div>').join('');
  }

  function renderGrafico(categorias) {
    const ctx = document.getElementById('grafico').getContext('2d');
    if (grafico) grafico.destroy();
    const keys = Object.keys(categorias);
    if (!keys.length) return;
    const colors = ['#00e5a0','#ff4d6d','#ffd166','#a78bfa','#06d6a0','#ef476f','#60a5fa','#8ecae6','#219ebc','#023e8a'];
    grafico = new Chart(ctx, { type: 'doughnut', data: { labels: keys, datasets: [{ data: Object.values(categorias), backgroundColor: colors.slice(0, keys.length), borderWidth: 2, borderColor: '#111418', hoverOffset: 6 }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: { color: '#5a6370', font: { family: 'DM Mono', size: 11 }, boxWidth: 12, padding: 12 } }, tooltip: { callbacks: { label: ctx => ' R$ ' + ctx.raw.toLocaleString('pt-BR', { minimumFractionDigits: 2 }) } } }, cutout: '60%' } });
  }

  function traduzirErro(code) {
    const erros = { 'auth/user-not-found':'Usuario nao encontrado.','auth/wrong-password':'Senha incorreta.','auth/invalid-email':'Email invalido.','auth/email-already-in-use':'Email ja cadastrado.','auth/weak-password':'Senha muito fraca.','auth/invalid-credential':'Email ou senha incorretos.','auth/too-many-requests':'Muitas tentativas. Tente mais tarde.','auth/network-request-failed':'Erro de conexao.' };
    return erros[code] || 'Ocorreu um erro. Tente novamente.';
  }

  function showToast(msg, tipo) {
    const old = document.querySelector('.toast'); if (old) old.remove();
    const toast = document.createElement('div');
    toast.className = 'toast' + (tipo ? ' ' + tipo : '');
    toast.textContent = msg; document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
</body>
</html>
